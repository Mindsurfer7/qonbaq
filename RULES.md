Понял, нужна четкая инструкция для ИИ, чтобы она писала код проекта строго по заданным принципам, с использованием технологий, паттернов и best practices, а не просто пошаговая инструкция.

***

# Инструкция для ИИ по написанию кода BACKEND (Node.js + Fastify + Prisma)

## 1. Общие принципы кода

- Пиши **чистый, читаемый, поддерживаемый и модульный код**.
- Обязательно используй **async/await** для асинхронных операций.
- Все конфигурации, секреты и константы храни в файле `.env` и считывай через `dotenv`.
- Используй **TypeScript** или максимальные type hints (если поддерживается), либо тщательно документируй типы.
- Каждый файл/модуль должен иметь узкую ответственность — разделяй логику бизнес-процессов, доступа к данным и роутов.
- Используй **dependency injection** через плагины Fastify (`fastify-plugin`) для расширения функционала (Prisma, авторизация и пр.).
- Логика бизнес-кейсов должна быть абстрагирована в отдельные слои/services, не смешивай её с роутами.
- Пиши **документацию в коде** через JSDoc/TSDoc для функций и классов.
- Обрабатывай ошибки на уровне middleware и возвращай понятные клиенту статусы и сообщения (REST стандарты).
- Пиши автоматические тесты (unit и интеграционные) для ключевых компонентов.

***

## 2. Технологии и инструменты (обязательно к использованию)

- **Fastify** — основной HTTP-фреймворк, используем только его.
- **Prisma ORM** — для взаимодействия с базой данных (начинаем с SQLite, далее Postgres).
- **dotenv** — управление конфигурацией и секретами.
- **fastify-plugin** — для расширения функционала Fastify модульно.
- **Zod/Typebox** или JSON Schema — для валидации входящих запросов и данных.
- **Pino** — логирование (встроенный Fastify логгер).
- **Jest** или **Vitest** — для тестирования.
- **ESLint + Prettier** — для стандартизации и форматирования кода.
- **OpenAPI / Swagger** — для документирования API.

***

## 3. Архитектурные паттерны и структура проекта

- **Своя, явно выраженная структура проекта:**

```
/src
  /plugins      # fastify плагины (prisma, auth и др.)
  /services     # бизнес-логика и доступ к данным (сервисный слой)
  /routes       # http маршруты, minimal роуты только, делегируют в сервисы
  /schemas      # схемы валидации запросов и ответов
  /utils        # общие утилиты
  /tests        # тесты (unit/integration)
  index.ts      # точка входа приложения
```

- **Dependency Injection через плагины.**
- Использовать **слой сервисов**, чтобы отделить бизнес-логику от HTTP-слоя.
- Все асинхронные операции через async/await, с try/catch.
- Использовать стандартизированные REST коды (200, 400, 404, 500).
- Писать SQL-запросы через Prisma ORM, без "сырых" SQL.
- Обрабатывать ошибки глобально через Fastify hook `setErrorHandler`.

***

## 4. Кодирование и документация

- Каждый метод и класс должен сопровождаться JSDoc с описанием, параметрами и результатами.
- Код должен идти с полным типом данных и строгой типизацией.
- Вместо магических констант — использовать enum и константы.
- Использовать функциональный стиль или классы по смыслу, не смешивая.
- Для валидации данных использовать отдельные схемы с Zod или JSON Schema, интегрировать с Fastify через `fastify-schema-validator`.
- Обязательно покрывать тестами (минимум 80% покрытие на core business logic).
- В коде использовать только современные возможности языка (ES2020+).

***

## 5. Обработка ошибок и логирование

- Все HTTP-ошибки должны иметь структуру:

```json
{
  "statusCode": 400,
  "error": "Bad Request",
  "message": "Пояснение ошибки"
}
```

- Использовать Fastify hook для централизованной обработки ошибок.
- Логи должны быть подробными для дебага (использовать pino с уровнем логирования configurable).
- Ошибки сетевого уровня (парсинга, БД) должны логироваться и приводить в понятный клиенту вид.
- Не выводить секреты и стектрейсы в продакшене.

***

## 6. Порядок действий и рабочие шаги

- Создай Fastify инстанс.
- Зарегистрируй плагины (Prisma, валидацию, auth).
- Определи схемы данных.
- Определи HTTP маршруты (routes), в них делегируй бизнес-логику сервисам.
- В сервисах прописывай всю логику с Prisma.
- Добавь centralized error handler.
- Добавь логирование.
- Определи тесты для всех слоёв.
- Документируй API в OpenAPI.
- Используй lint и форматирование кода.

***

## 7. Чего не делать

- Не смешивай логику запросов с бизнес-логикой.
- Не делать неструктурированный код типа "все в одном файле".
- Не пиши "сырые" SQL без необходимости.
- Не пренебрегай валидацией и обработкой ошибок.
- Не пиши глобальные переменные, только контексты и DI.

***

Если нужны конкретные примеры паттернов кода, пишу отдельно.  
Это руководство позволит ИИ писать мощный, надежный и поддерживаемый backend, используя Fastify и Prisma согласно современным стандартам разработки.

Источники
